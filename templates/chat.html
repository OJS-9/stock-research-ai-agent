{% extends "base.html" %}

{% block content %}
<header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-b-stone-200 dark:border-b-border-dark bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md px-4 sm:px-10 py-3">
    <div class="flex items-center gap-4 text-stone-900 dark:text-white">
        <div class="size-8 text-primary">
            <svg class="w-full h-full" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                <path d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z" fill="currentColor"></path>
            </svg>
        </div>
        <h2 class="text-stone-900 dark:text-white text-xl font-bold leading-tight tracking-[-0.015em] font-display">StockIntel / Chat</h2>
    </div>
    <div class="hidden md:flex flex-1 justify-end gap-8">
        <div class="flex items-center gap-9">
            <a class="text-stone-900 dark:text-white hover:text-primary transition-colors text-sm font-medium leading-normal" href="{{ url_for('index') }}">Dashboard</a>
            <a class="text-stone-900 dark:text-white hover:text-primary transition-colors text-sm font-medium leading-normal" href="{{ url_for('chat') }}">AI Agent</a>
            <a class="text-stone-900 dark:text-white hover:text-primary transition-colors text-sm font-medium leading-normal" href="#">Watchlist</a>
        </div>
        <div class="flex items-center justify-center size-10 rounded-full bg-surface-dark border border-border-dark">
            <span class="material-symbols-outlined text-white text-xl">account_circle</span>
        </div>
    </div>
    <div class="md:hidden text-white">
        <span class="material-symbols-outlined cursor-pointer">menu</span>
    </div>
</header>

<main class="flex-1 flex flex-col w-full max-w-6xl mx-auto px-4 py-6">
    <div class="flex-1 overflow-y-auto mb-4 space-y-6 pb-4" id="chat-messages">
        {% if not conversation_history or conversation_history|length == 0 %}
        <!-- AI Greeting Message -->
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 size-8 rounded-full bg-surface-dark flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-sm font-bold text-white">StockIntel AI</span>
                    <span class="text-xs text-stone-500">10:02 AM</span>
                </div>
                <div class="bg-surface-dark rounded-2xl px-4 py-3 max-w-3xl">
                    <p class="text-white text-sm leading-relaxed">
                        Hello! I'm your advanced market research assistant. I can analyze real-time stock data, summarize complex financial reports, or visualize market trends for you. Try asking: 'Analyze NVDA performance' or 'What's happening with Crypto today?'
                    </p>
                </div>
            </div>
        </div>
        {% else %}
            {% for message in conversation_history %}
                {% if message.role == 'user' %}
                <!-- User Message -->
                <div class="flex items-start gap-3 justify-end">
                    <div class="flex-1 flex justify-end">
                        <div class="max-w-3xl">
                            <div class="flex items-center gap-2 mb-1 justify-end">
                                <span class="text-xs text-stone-500">10:02 AM</span>
                                <span class="text-sm font-bold text-white">You</span>
                            </div>
                            <div class="bg-surface-dark rounded-2xl px-4 py-3">
                                <p class="text-white text-sm leading-relaxed">{{ message.content }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 size-8 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-xl">person</span>
                    </div>
                </div>
                {% else %}
                <!-- AI Message -->
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 size-8 rounded-full bg-surface-dark flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-bold text-white">StockIntel AI</span>
                            <span class="text-xs text-stone-500">10:02 AM</span>
                        </div>
                        <div class="bg-surface-dark rounded-2xl px-4 py-3 max-w-3xl">
                            <div class="text-white text-sm leading-relaxed markdown-content">{{ message.content | markdown | safe }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    
    <!-- Input Field -->
    <div class="sticky bottom-0 bg-background-dark pt-4 pb-2">
        <form method="POST" action="{{ url_for('continue_conversation') }}" class="flex items-center gap-2 bg-surface-dark rounded-2xl p-2 border border-border-dark">
            <button type="button" class="flex-shrink-0 size-10 flex items-center justify-center text-stone-400 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-2xl">add</span>
            </button>
            <input 
                type="text" 
                name="user_response"
                id="user_response"
                placeholder="Ask about stocks, markets, or news..." 
                class="flex-1 bg-transparent border-none text-white placeholder:text-stone-500 focus:ring-0 focus:outline-none text-sm"
                required
            />
            <button 
                type="submit" 
                class="flex-shrink-0 size-10 rounded-full bg-primary hover:bg-white text-background-dark flex items-center justify-center transition-all hover:scale-105 active:scale-95"
            >
                <span class="material-symbols-outlined text-xl">arrow_upward</span>
            </button>
        </form>
        <p class="text-xs text-stone-500 text-center mt-2">
            StockIntel AI can make mistakes. Verify important financial data.
        </p>
    </div>
</main>

<script>
    // Auto-scroll to bottom on page load
    window.addEventListener('load', function() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });

    // Configure marked.js for security and better rendering
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,  // Convert line breaks to <br>
            gfm: true,     // GitHub Flavored Markdown
            headerIds: false,  // Disable header IDs for security
            mangle: false
        });
    }

    // Handle form submission via AJAX
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[action="{{ url_for('continue_conversation') }}"]');
        const input = document.getElementById('user_response');
        const chatMessages = document.getElementById('chat-messages');
        
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/27ce924a-188a-4f1b-bc7b-66a0f39e7341',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'chat.html:185',message:'DOMContentLoaded - checking form elements',data:{formFound:!!form,inputFound:!!input,chatMessagesFound:!!chatMessages},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        
        if (form && input && chatMessages) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission
                
                const userMessage = input.value.trim();
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/27ce924a-188a-4f1b-bc7b-66a0f39e7341',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'chat.html:194',message:'Form submit - userMessage value',data:{userMessage:userMessage,userMessageLength:userMessage.length,inputValue:input.value},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                
                if (!userMessage) return;
                
                // Create FormData BEFORE disabling input (disabled fields are excluded from FormData)
                const formData = new FormData(form);
                // Manually append userMessage to ensure it's included (disabled fields may not be captured)
                formData.set('user_response', userMessage);
                
                // #region agent log
                const formDataEntries = Array.from(formData.entries());
                fetch('http://127.0.0.1:7242/ingest/27ce924a-188a-4f1b-bc7b-66a0f39e7341',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'chat.html:214',message:'FormData created and userMessage appended',data:{formDataEntries:formDataEntries,userResponseInFormData:formData.get('user_response'),userMessage:userMessage},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix-v2',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
                
                // Disable form while processing
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonContent = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="material-symbols-outlined text-xl animate-spin">sync</span>';
                input.disabled = true;
                
                // Add user message to chat immediately
                const userMessageDiv = createUserMessage(userMessage);
                chatMessages.appendChild(userMessageDiv);
                scrollToBottom();
                
                // Clear input (now safe to clear since FormData is already created)
                input.value = '';
                
                // Detect if this might trigger report generation
                const reportKeywords = ['generate', 'report', 'create report', 'synthesize', 'final report', 'business model'];
                const lowerMessage = userMessage.toLowerCase();
                const isLikelyReportGeneration = reportKeywords.some(keyword => lowerMessage.includes(keyword));
                
                // Add loading indicator for AI response
                // Start with regular thinking, switch to synthesis messages if it takes longer
                const loadingDiv = createLoadingMessage(false);
                chatMessages.appendChild(loadingDiv);
                scrollToBottom();
                
                // If likely report generation, switch to synthesis messages after 2 seconds
                // Also switch if loading takes longer than 5 seconds (indicating report generation)
                let synthesisCheckTimeout = null;
                let longLoadingTimeout = null;
                
                const switchToSynthesisMessages = () => {
                    const loadingText = loadingDiv.querySelector('#loading-message-text');
                    if (loadingText && document.body.contains(loadingText)) {
                        loadingText.textContent = synthesisMessages[0];
                        synthesisMessageIndex = 0;
                        startSynthesisMessageRotation(loadingDiv);
                    }
                };
                
                if (isLikelyReportGeneration) {
                    synthesisCheckTimeout = setTimeout(switchToSynthesisMessages, 2000);
                }
                
                // Always check after 5 seconds - if still loading, probably synthesis
                longLoadingTimeout = setTimeout(() => {
                    const loadingText = loadingDiv.querySelector('#loading-message-text');
                    if (loadingText && loadingText.textContent === 'Thinking...') {
                        switchToSynthesisMessages();
                    }
                }, 5000);
                
                try {
                    // Send request via fetch (FormData already created with correct value)
                    
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest' // Identify as AJAX request
                        }
                    });
                    
                    // Stop synthesis message rotation and remove loading indicator
                    stopSynthesisMessageRotation();
                    if (synthesisCheckTimeout) {
                        clearTimeout(synthesisCheckTimeout);
                    }
                    if (longLoadingTimeout) {
                        clearTimeout(longLoadingTimeout);
                    }
                    loadingDiv.remove();
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Add assistant message
                            const assistantDiv = createAssistantMessage(data.assistant_message);
                            chatMessages.appendChild(assistantDiv);
                            
                            // If a report was generated, add it as well
                            if (data.report_generated && data.report_preview) {
                                const reportDiv = createAssistantMessage(data.report_preview);
                                chatMessages.appendChild(reportDiv);
                            }
                            
                            scrollToBottom();
                        } else {
                            // Server returned error
                            const errorDiv = createErrorMessage(data.error || 'Failed to send message. Please try again.');
                            chatMessages.appendChild(errorDiv);
                            scrollToBottom();
                        }
                    } else {
                        // HTTP error status
                        const errorData = await response.json().catch(() => ({ error: 'Server error occurred' }));
                        const errorDiv = createErrorMessage(errorData.error || `Error ${response.status}: ${response.statusText}`);
                        chatMessages.appendChild(errorDiv);
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    stopSynthesisMessageRotation();
                    if (synthesisCheckTimeout) {
                        clearTimeout(synthesisCheckTimeout);
                    }
                    if (longLoadingTimeout) {
                        clearTimeout(longLoadingTimeout);
                    }
                    loadingDiv.remove();
                    const errorDiv = createErrorMessage('Network error: Failed to send message. Please check your connection and try again.');
                    chatMessages.appendChild(errorDiv);
                    scrollToBottom();
                } finally {
                    // Re-enable form
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                    input.disabled = false;
                    input.focus();
                }
            });
        }
    });
    
    // Helper function to scroll to bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            // Use requestAnimationFrame for smooth scrolling
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
    }
    
    // Create user message element
    function createUserMessage(content) {
        const div = document.createElement('div');
        div.className = 'flex items-start gap-3 justify-end';
        const timeString = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        div.innerHTML = `
            <div class="flex-1 flex justify-end">
                <div class="max-w-3xl">
                    <div class="flex items-center gap-2 mb-1 justify-end">
                        <span class="text-xs text-stone-500">${timeString}</span>
                        <span class="text-sm font-bold text-white">You</span>
                    </div>
                    <div class="bg-surface-dark rounded-2xl px-4 py-3">
                        <p class="text-white text-sm leading-relaxed">${escapeHtml(content)}</p>
                    </div>
                </div>
            </div>
            <div class="flex-shrink-0 size-8 rounded-full bg-primary/20 flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl">person</span>
            </div>
        `;
        return div;
    }
    
    // Create assistant message element
    function createAssistantMessage(content) {
        const div = document.createElement('div');
        div.className = 'flex items-start gap-3';
        const timeString = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Render markdown instead of escaping HTML
        const markdownContent = typeof marked !== 'undefined' ? marked.parse(content) : escapeHtml(content);
        
        div.innerHTML = `
            <div class="flex-shrink-0 size-8 rounded-full bg-surface-dark flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-sm font-bold text-white">StockIntel AI</span>
                    <span class="text-xs text-stone-500">${timeString}</span>
                </div>
                <div class="bg-surface-dark rounded-2xl px-4 py-3 max-w-3xl">
                    <div class="text-white text-sm leading-relaxed markdown-content">${markdownContent}</div>
                </div>
            </div>
        `;
        return div;
    }
    
    // Synthesis status messages for report generation
    const synthesisMessages = [
        "Synthesizing research findings into comprehensive report...",
        "Combining insights from all research areas...",
        "Organizing analysis into structured format...",
        "Integrating financial data and market research...",
        "Crafting investment thesis and recommendations...",
        "Writing executive summary and key conclusions...",
        "Formatting final report sections..."
    ];
    
    let synthesisMessageIndex = 0;
    let synthesisMessageInterval = null;
    
    // Create loading message element
    function createLoadingMessage(isSynthesisPhase = false) {
        const div = document.createElement('div');
        div.className = 'flex items-start gap-3';
        div.id = 'loading-message';
        const timeString = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Determine initial message
        let initialMessage = "Thinking...";
        if (isSynthesisPhase && synthesisMessages.length > 0) {
            initialMessage = synthesisMessages[0];
            synthesisMessageIndex = 0;
        }
        
        div.innerHTML = `
            <div class="flex-shrink-0 size-8 rounded-full bg-surface-dark flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-xl">smart_toy</span>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-sm font-bold text-white">StockIntel AI</span>
                    <span class="text-xs text-stone-500">${timeString}</span>
                </div>
                <div class="bg-surface-dark rounded-2xl px-4 py-3 max-w-3xl">
                    <div class="flex items-center gap-2">
                        <div class="animate-pulse text-stone-400 text-sm" id="loading-message-text">${initialMessage}</div>
                    </div>
                </div>
            </div>
        `;
        
        // Start rotating messages if in synthesis phase
        if (isSynthesisPhase) {
            startSynthesisMessageRotation(div);
        }
        
        return div;
    }
    
    // Rotate synthesis messages every 10 seconds
    function startSynthesisMessageRotation(loadingDiv) {
        // Clear any existing interval
        if (synthesisMessageInterval) {
            clearInterval(synthesisMessageInterval);
        }
        
        const messageElement = loadingDiv.querySelector('#loading-message-text');
        if (!messageElement || synthesisMessages.length === 0) return;
        
        synthesisMessageIndex = 0;
        
        synthesisMessageInterval = setInterval(() => {
            if (messageElement && document.body.contains(messageElement)) {
                synthesisMessageIndex = (synthesisMessageIndex + 1) % synthesisMessages.length;
                messageElement.textContent = synthesisMessages[synthesisMessageIndex];
            } else {
                // Element removed, stop rotation
                clearInterval(synthesisMessageInterval);
                synthesisMessageInterval = null;
            }
        }, 10000); // Change message every 10 seconds
    }
    
    // Stop synthesis message rotation
    function stopSynthesisMessageRotation() {
        if (synthesisMessageInterval) {
            clearInterval(synthesisMessageInterval);
            synthesisMessageInterval = null;
        }
    }
    
    // Create error message element
    function createErrorMessage(content) {
        const div = document.createElement('div');
        div.className = 'flex items-start gap-3';
        div.innerHTML = `
            <div class="flex-shrink-0 size-8 rounded-full bg-red-500/20 flex items-center justify-center">
                <span class="material-symbols-outlined text-red-400 text-xl">error</span>
            </div>
            <div class="flex-1">
                <div class="bg-red-500/10 rounded-2xl px-4 py-3 max-w-3xl border border-red-500/20">
                    <p class="text-red-400 text-sm leading-relaxed">${escapeHtml(content)}</p>
                </div>
            </div>
        `;
        return div;
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

<style>
    /* Markdown Content Styling */
    .markdown-content {
        line-height: 1.7;
    }
    
    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: #ffffff;
        font-weight: 700;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.3;
    }
    
    .markdown-content h1 {
        font-size: 1.5em;
        border-bottom: 1px solid #292524;
        padding-bottom: 0.5em;
    }
    
    .markdown-content h2 {
        font-size: 1.3em;
        border-bottom: 1px solid #292524;
        padding-bottom: 0.4em;
    }
    
    .markdown-content h3 {
        font-size: 1.15em;
    }
    
    .markdown-content h4 {
        font-size: 1.05em;
    }
    
    .markdown-content p {
        margin-bottom: 1em;
    }
    
    .markdown-content ul,
    .markdown-content ol {
        margin: 1em 0;
        padding-left: 1.5em;
    }
    
    .markdown-content li {
        margin: 0.5em 0;
    }
    
    .markdown-content ul {
        list-style-type: disc;
    }
    
    .markdown-content ol {
        list-style-type: decimal;
    }
    
    .markdown-content code {
        background-color: #0c0a09;
        color: #22c55e;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        border: 1px solid #292524;
    }
    
    .markdown-content pre {
        background-color: #0c0a09;
        border: 1px solid #292524;
        border-radius: 0.5rem;
        padding: 1em;
        overflow-x: auto;
        margin: 1em 0;
    }
    
    .markdown-content pre code {
        background-color: transparent;
        color: #d6d3d1;
        padding: 0;
        border: none;
        display: block;
        white-space: pre;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #d6d3d1;
        padding-left: 1em;
        margin: 1em 0;
        color: #a8a29e;
        font-style: italic;
    }
    
    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
        border: 1px solid #292524;
    }
    
    .markdown-content th,
    .markdown-content td {
        padding: 0.75em;
        text-align: left;
        border: 1px solid #292524;
    }
    
    .markdown-content th {
        background-color: #1c1917;
        font-weight: 600;
        color: #ffffff;
    }
    
    .markdown-content td {
        background-color: #0c0a09;
    }
    
    .markdown-content a {
        color: #22c55e;
        text-decoration: underline;
        transition: color 0.2s;
    }
    
    .markdown-content a:hover {
        color: #16a34a;
    }
    
    .markdown-content hr {
        border: none;
        border-top: 1px solid #292524;
        margin: 2em 0;
    }
    
    .markdown-content strong {
        font-weight: 700;
        color: #ffffff;
    }
    
    .markdown-content em {
        font-style: italic;
    }
    
    .markdown-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1em 0;
    }
</style>
{% endblock %}

